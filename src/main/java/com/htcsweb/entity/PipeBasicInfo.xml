<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.htcsweb.dao.PipeBasicInfoDao">

    <resultMap id="all" type="com.htcsweb.entity.PipeBasicInfo">
        <id property="id" column="id"></id>
        <result property="contract_no" column="contract_no"></result>
        <result property="pipe_no" column="pipe_no"></result>
        <result property="grade" column="grade"></result>
        <result property="od" column="od"></result>
        <result property="wt" column="wt"></result>
        <result property="p_length" column="p_length"></result>
        <result property="weight" column="weight"></result>
        <result property="pipe_making_lot_no" column="pipe_making_lot_no"></result>
        <result property="status" column="status"></result>
        <result property="heat_no" column="heat_no"></result>
        <result property="storage_stack" column="storage_stack"></result>
        <result property="stack_level" column="stack_level"></result>
        <result property="od_coating_date" column="od_coating_date"></result>
        <result property="id_coating_date" column="id_coating_date"></result>

    </resultMap>

    <select id="getPipeNumbers" resultType="com.htcsweb.entity.PipeBasicInfo">
        SELECT  p.*  from pipe_basic_info p INNER JOIN contract_info c ON
        p.contract_no=c.contract_no
        <where>
            <if test="pipestatus!=null">
                <foreach collection="pipestatus" item="item" open="status in (" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            <if test="external_coatingtype!=null and external_coatingtype!=''">
                AND c.external_coating=#{external_coatingtype}
            </if>
        </where>

        ORDER BY id DESC
        limit 1000
    </select>

    <!--
    app 搜索算法
    排序规则：最新生产的最优先（比较时间为od打砂时间然后是id打砂时间，降序排列），其次是已生产完成的，最后是光管
    -->
    <select id="searchPipe" resultType="map">
        SELECT p.*,s.status_name,odb.operation_time,idb.operation_time from pipe_basic_info p inner join pipe_status s on p.status=s.status_code
        left join (select  pipe_no, max(operation_time) as operation_time from od_blast_process   group by pipe_no) as odb
        on odb.pipe_no=p.pipe_no
        left join (select  pipe_no, max(operation_time) as operation_time  from id_blast_process  group by pipe_no) as idb
        on idb.pipe_no=p.pipe_no

        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND p.pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY odb.operation_time DESC,idb.operation_time DESC
        limit #{skip},#{take}
    </select>


    <select id="searchPipeCount" resultType="int">
        SELECT count(*) from pipe_basic_info p inner join pipe_status s on p.status=s.status_code
        left join (select  pipe_no, max(operation_time) as operation_time from od_blast_process   group by pipe_no) as odb
        on odb.pipe_no=p.pipe_no
        left join (select  pipe_no, max(operation_time) as operation_time  from id_blast_process  group by pipe_no) as idb
        on idb.pipe_no=p.pipe_no

        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND p.pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY odb.operation_time DESC,idb.operation_time DESC
    </select>





     <select id="getPipeNumber" resultType="com.htcsweb.entity.PipeBasicInfo">
         SELECT *  from pipe_basic_info
         <where>
             <if test="pipe_no!=null and pipe_no!=''">
                 AND pipe_no =#{pipe_no}
             </if>
         </where>
         ORDER BY id DESC
         limit 1000
     </select>


<!--
    得到2fbe实验管的管号，包括dsc实验
-->
    <select id="get2FBESamplePipeNo" resultType="com.htcsweb.entity.PipeBasicInfo">
        select * from pipe_basic_info where  pipe_no in(
        select pipe_no from od_coating_2fbe_inspection_process ic where is_sample='1' or is_dsc_sample='1'
        )
        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY id DESC
        limit 1000
    </select>

    <!--
    得到3lpe实验管的管号，包括dsc实验,pe实验
-->
    <select id="get3LPESamplePipeNo" resultType="com.htcsweb.entity.PipeBasicInfo">
        select * from pipe_basic_info where  pipe_no in(
        select pipe_no from od_coating_3lpe_inspection_process ic where is_sample='1' or is_dsc_sample='1' or is_pe_sample='1'
         )
        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY id DESC
        limit 1000
    </select>
    <!--
       得到Liquid Epoxy实验管的管号，包括玻璃片实验,常规实验
   -->
    <select id="getLiquidEpoxySamplePipeNo" resultType="com.htcsweb.entity.PipeBasicInfo">
        select * from pipe_basic_info where  pipe_no in(
        select pipe_no from id_coating_inspection_process ic where is_sample='1' or is_glass_sample='1'
        )
        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY id DESC
        limit 1000
    </select>




    <select id="getODSamplePipeNumbers" resultType="com.htcsweb.entity.PipeBasicInfo">
        select * from pipe_basic_info where  pipe_no in(
--         select pipe_no from id_coating_inspection_process ic where is_sample='1' UNION
        select pipe_no from od_coating_2fbe_inspection_process ic where is_sample='1' UNION
        select pipe_no from od_coating_3lpe_inspection_process ic where is_sample='1'
        )
        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY id DESC
        limit 1000
    </select>


    <select id="getNeedRebevelPipeNumbers" resultType="com.htcsweb.entity.PipeBasicInfo">
        select * from pipe_basic_info where  pipe_no in(
        select pipe_no from pipe_sampling_record spl  UNION
        select pipe_no from bare_pipe_grinding_cutoff_record gc where grinding_cutoff='C' or grinding_cutoff='GC'
        ) and pipe_no not in(
        select pipe_no from pipe_rebevel_record reb where result=1
        )
        <where>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
        </where>
        ORDER BY id DESC
        limit 1000
    </select>


    <!--<delete id="delOdCoatingProcess">-->
        <!--delete from od_coating_2fbe_process WHERE-->
        <!--<foreach collection="array" item="item" open="id in (" separator="," close=")">-->
            <!--#{item}-->
        <!--</foreach>-->
    <!--</delete>-->

    <select id="getCountODIDBarePipeInfoByLike" resultType="int">
        select count(*) from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>

            <if test="status!=null and status!=''">
                AND status = #{status}
            </if>
            AND (status = 'bare1' or status = 'bare2')
        </where>
    </select>


    <select id="getODIDBarePipeInfoByLike" resultType="map">
        select co.project_no,co.external_coating,co.internal_coating, project_name, p.*
        from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>

            <if test="status!=null and status!=''">
                AND status = #{status}
            </if>
            AND (status = 'bare1' or status = 'bare2' or status = 'odstrip2' or status = 'idstrip2')
        </where>
        ORDER BY id DESC
        limit #{skip},#{take}
    </select>

    <select id="getCount" resultType="int">
        select count(*) from pipe_basic_info
    </select>

    <select id="getCountAllByLike" resultType="int">
        select count(*) from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            <if test="status!=null and status!=''">
                AND p.status = #{status}
            </if>
        </where>
    </select>

    <select id="getCountODInspectedPipeInfoByLike" resultType="int">
        select count(*) from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            AND p.status = 'od6'
        </where>
    </select>

    <select id="getCountIDInspectedPipeInfoByLike" resultType="int">
        select count(*) from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            AND p.status = 'id6'
        </where>
    </select>




    <select id="getAllByLike" resultType="map">
        select co.project_no,co.external_coating,co.internal_coating, project_name, p.* from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            <if test="status!=null and status!=''">
                AND p.status = #{status}
            </if>
        </where>
        ORDER BY id DESC
        limit #{skip},#{take}
    </select>



    <select id="getODInspectedPipeInfoByLike" resultType="map">
        select co.project_no,co.external_coating,co.internal_coating, project_name, p.* from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
               AND p.status = 'od6'
        </where>
        ORDER BY id DESC
        limit #{skip},#{take}
    </select>


    <select id="getIDInspectedPipeInfoByLike" resultType="map">
        select co.project_no,co.external_coating,co.internal_coating, project_name, p.* from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            AND p.status = 'id6'
        </where>
        ORDER BY id DESC
        limit #{skip},#{take}
    </select>

    <select id="getPipeInfoByNo" resultType="map">
        Select p.od_coating_date, p.id_coating_date, p.pipe_making_lot_no,client_spec, coating_standard,p.pipe_no,pro.project_no,pro.project_name,s.status_name,p.contract_no,p.grade,p.od,p.wt,p.p_length,p.weight,p.heat_no from pipe_basic_info p
        LEFT join contract_info c on p.contract_no=c.contract_no
        LEFT join project_info pro on c.project_no=pro.project_no
        LEFT join pipe_status s on s.status_code=p.status
        WHERE p.pipe_no=#{pipe_no}
    </select>

    <update id="updatePipeBasicInfo" parameterType="com.htcsweb.entity.PipeBasicInfo">
        UPDATE pipe_basic_info set contract_no=#{contract_no},pipe_no=#{pipe_no},grade=#{grade},od=#{od},wt=#{wt},p_length=#{p_length}, weight=#{weight},pipe_making_lot_no=#{pipe_making_lot_no},status=#{status}, heat_no=#{heat_no},storage_stack=#{storage_stack},stack_level=#{stack_level},od_coating_date=#{od_coating_date},id_coating_date=#{id_coating_date} WHERE id=#{id}
    </update>

    <insert id="addPipeBasicInfo" parameterType="com.htcsweb.entity.PipeBasicInfo">
        INSERT INTO pipe_basic_info(contract_no,pipe_no,grade,od,wt,p_length,weight,pipe_making_lot_no,status,heat_no,storage_stack,stack_level,od_coating_date,id_coating_date)
        VALUES (#{contract_no},#{pipe_no},#{grade},#{od},#{wt},#{p_length},#{weight},#{pipe_making_lot_no},#{status},#{heat_no},#{storage_stack},#{stack_level},#{od_coating_date},#{id_coating_date})
    </insert>

    <delete id="delPipeBasicInfo">
        delete from pipe_basic_info WHERE
        <foreach collection="array" item="item" open="id in (" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <update id="odProductStockin" parameterType="com.htcsweb.entity.PipeBasicInfo">
        UPDATE pipe_basic_info set status='odstockin',storage_stack=#{storage_stack}, stack_level=#{stack_level} WHERE  status='od6' AND
        <foreach collection="array" item="item" open="id in (" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="idProductStockin" parameterType="com.htcsweb.entity.PipeBasicInfo">
        UPDATE pipe_basic_info set status='idstockin', storage_stack=#{storage_stack}, stack_level=#{stack_level}  WHERE  status='id6' AND
        <foreach collection="array" item="item" open="id in (" separator="," close=")">
            #{item}
        </foreach>
    </update>


    <update id="SetToODBare" parameterType="com.htcsweb.entity.PipeBasicInfo">
        UPDATE pipe_basic_info set status='bare1' WHERE  (status='bare2' or status='odstrip2') AND
        <foreach collection="array" item="item" open="id in (" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="SetToIDBare" parameterType="com.htcsweb.entity.PipeBasicInfo">
        UPDATE pipe_basic_info set status='bare2' WHERE  (status='bare1' or status='idstrip2') AND
        <foreach collection="array" item="item" open="id in (" separator="," close=")">
            #{item}
        </foreach>
    </update>


    <select id="getCoatedStockinPipeInfoByLike" resultType="map">
        select co.project_no,co.external_coating,co.internal_coating, project_name, p.* from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            <if test="status!=null and status!=''">
                AND p.status = #{status}
            </if>
            AND (p.status = 'odstockin' or p.status = 'idstockin')
        </where>
        ORDER BY id DESC
        limit #{skip},#{take}
    </select>
    <select id="getCountCoatedStockinPipeInfoByLike" resultType="int">
        select count(*) from pipe_basic_info p
        left join contract_info co on p.contract_no=co.contract_no
        left join  project_info pr on co.project_no=pr.project_no
        <where>
            <if test="project_no!=null and project_no!=''">
                AND co.project_no LIKE CONCAT('%',#{project_no},'%')
            </if>

            <if test="contract_no!=null and contract_no!=''">
                AND p.contract_no LIKE CONCAT('%',#{contract_no},'%')
            </if>
            <if test="pipe_no!=null and pipe_no!=''">
                AND pipe_no LIKE CONCAT('%',#{pipe_no},'%')
            </if>
            <if test="status!=null and status!=''">
                AND p.status = #{status}
            </if>
            AND (p.status = 'odstockin' or p.status = 'idstockin')
        </where>
    </select>


    <update id="coatingProductStockout" parameterType="com.htcsweb.entity.PipeBasicInfo">
        UPDATE pipe_basic_info set status='out' WHERE  (status='odstockin' or status='idstockin') AND
        <foreach collection="array" item="item" open="id in (" separator="," close=")">
            #{item}
        </foreach>
    </update>


    <select id="isPipeODProcessed"  resultType="int">
        select count(p.id) from od_blast_process o
        inner join pipe_basic_info p on p.pipe_no=o.pipe_no
        inner join pipe_status s on s.status_code=p.status
        <where>
            <if test="id!=null and id!=''">
                AND p.id = #{id}
            </if>
                AND p.status <![CDATA[ <> ]]>  'odstrip2'
        </where>
    </select>

    <select id="isPipeIDProcessed"  resultType="int">
        select count(p.id) from id_blast_process o
        inner join pipe_basic_info p on p.pipe_no=o.pipe_no
        inner join pipe_status s on s.status_code=p.status
        <where>
            <if test="id!=null and id!=''">
                AND p.id = #{id}
            </if>
                AND p.status <![CDATA[ <> ]]>  'idstrip2'
        </where>
    </select>
    <select id="getPipeNoByContractNo" resultType="java.lang.String">
        SELECT pipe_no from pipe_basic_info WHERE
        <foreach collection="array" item="item" open="contract_no in (" separator="," close=")">
            #{item}
        </foreach>
    </select>

</mapper>